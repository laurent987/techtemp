### Objectif

Deliver a **functional and tested implementation** of the MQTT wrapper in the service-app:
- `createMqttClient(opts)` returning `{ client, subscribe, publish, onMessage, close }`.  
- **Promise-based** abstraction for `subscribe/publish` (default QoS = 1).  
- Clear **lifecycle management** (initial connect, auto-retry by mqtt.js, graceful shutdown).  

### Contexte

Journal #001 defined the contracts (MQTT/DB/API) and skeletons of the modules.  

### Décisions

- Use `mqtt` (mqtt.js v4) as the client library.  
- Expose a **minimal façade** → `subscribe(topic, qos=1)`, `publish(topic, msg, opts)`, `onMessage(handler)`, `close()`.  
- Support optional LWT configuration in `opts`.  
- Run integration tests with an **embedded `aedes` broker** (ephemeral port) to avoid Docker dependency locally.  
- Write JSDoc in English (consistent with other JS files).  

### Portée (Scope / Done)

- Implement `createMqttClient()` (connect, subscribe, publish, onMessage, close).  
- Safe defaults: `clean=true`, `keepalive=60`, `qos=1`.  
- **Explicit errors** if `url` is missing, or subscription grant is denied.  
- **Vitest tests** with `aedes`:  
  - Connect + subscribe + publish → handler receives the message.  
  - Publish with default `qos=1`.  
  - Graceful shutdown (`close()`), no socket leaks.  

### Hors Portée (Out of scope)

- Custom exponential backoff (we rely on mqtt.js `reconnectPeriod`).  
- Topic parsing/filtering (`parseTopic.js` will cover this later).  
- Direct integration with ingestion pipeline (DB writes).  


### Artifacts produits

- `service-app/src/mqtt/client.js`  
- `service-app/test/mqtt.client.test.js`  
- `docs/journal/2025-09-05-entry-002.md`  

### Liens utiles

- Contrat MQTT (topics/payloads/QoS/retain) : `docs/contracts/001-service-app-contract.md`  
- Module ciblé : `service-app/src/mqtt/client.js`  
- Tests : `service-app/test/mqtt.client.test.js` 

### Plan d’implémentation

- [x] Write integration tests with `aedes` (Vitest):

   - Start an embedded broker on a free port (`beforeAll`).
   - Verify client connects successfully.
   - Verify `subscribe(topic)` resolves when granted.
   - Verify `publish(topic, msg)` resolves after ack.
   - Verify `onMessage(handler)` receives messages, supports multiple handlers, and returns an unsubscribe function.
   - Verify `close()` shuts down cleanly (no reconnect, no socket leaks).
   - Verify errors: missing `url` → throws explicit error; invalid topic → rejects.

- [x] Define and validate MQTT client options (`url`, credentials, LWT).

- [x] Implement `createMqttClient()` returning `{ client, subscribe, publish, onMessage, close }`.

- [x] Implement promise-based `subscribe()` (resolves when granted) and `publish()` (resolves after ack).

- [x] Add handler registry (`onMessage` with unsubscribe support).

- [x] Implement `close()` for graceful shutdown (disable reconnect, call `client.end`).


### Commandes exécutées (optionnel)

```bash
npm i mqtt@^5.14.1
npm i -D vitest@^3.2.4 aedes@^0.50.0
npm run test  # 14 tests passent
```

