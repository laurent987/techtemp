# ğŸ“Š **Journal de DÃ©veloppement #0### **Scope Principal**
- **Hardware Setup** : Raspberry Pi + capteur AHT20
- **Client C** : Programme C avec driver AHT20 + publ### **Validation Technique**
- [ ] Tests backend passent aprÃ¨s migration âœ…
- [ ] Programme C compile et lit donnÃ©es capteur AHT20
- [ ] DonnÃ©es arrivent en base SQLite
- [ ] API `/api/v1/readings` retourne donnÃ©es Pi

### **Validation Fonctionnelle**
- [ ] Raspberry Pi opÃ©rationnel + I2C activÃ©
- [ ] Capteur AHT20 fonctionnel via I2C
- [ ] Flux temps rÃ©el visible en logs
- [ ] PremiÃ¨re lecture device_uid rÃ©el en DB (ex: aht20-b827eb123456)T
- **Configuration** : I2C + connexion broker MQTT
- **Validation** : Premier point de donnÃ©e rÃ©el en DB
- **Architecture** : Mise en place structure monorepo

### **Livrables Attendus**
- [ ] Migration `src/` â†’ `backend/` (restructuration) âœ…
- [ ] CrÃ©ation dossier `device/` + structure projet C
- [ ] Programme C collecte tempÃ©rature/humiditÃ© via AHT20
- [ ] Driver I2C pour communication avec capteur AHT20
- [ ] Client MQTT en C pour publication donnÃ©es
- [ ] Configuration Raspberry Pi + I2C + rÃ©seau
- [ ] Premier flux de donnÃ©es rÃ©elles vers backend
- [ ] Documentation setup hardware + compilation
- [ ] Tests intÃ©gration bout-en-bout :** 11 septembre 2025  
**â±ï¸ DurÃ©e :** Session de dÃ©veloppement  
**ğŸ¯ Objectif :** Premier Capteur Physique Raspberry Pi

---

## ğŸš¨ **Changement Architecture Important**

### **âš ï¸ Modification DÃ©cision Journal #007**
**Ancienne dÃ©cision :** Repositories sÃ©parÃ©s (`techtemp-device`, `techtemp-web`)  
**Nouvelle dÃ©cision :** **Monorepo** - Tout dans `techtemp/`

### **Justification du Changement :**
- âœ… **SimplicitÃ© opÃ©rationnelle**
- âœ… **Documentation centralisÃ©e** : Journaux + code ensemble
- âœ… **DÃ©veloppement MVP** : Moins de complexitÃ© pour prototypage
- âœ… **Orchestration simplifiÃ©e** : Docker-compose unique

### **Nouvelle Structure Cible :**
```bash
techtemp/                    # Monorepo unifiÃ©
â”œâ”€â”€ backend/                 # Service IoT (migration de src/)
â”œâ”€â”€ device/                  # Client Raspberry Pi (Journal #008)
â”œâ”€â”€ web/                     # Interface web (Journal #009)
â”œâ”€â”€ docs/                    # Documentation + journaux
â”œâ”€â”€ infrastructure/          # Docker, configs globales
â””â”€â”€ scripts/                # Outils communs
```

---

## ğŸ¯ **Objectifs Journal #008**

### **Scope Principal**
- **Hardware Setup** : Raspberry Pi + capteur AHT20/DHT22
- **Client Python** : Script collecte + publication MQTT
- **Configuration** : Network + connexion broker
- **Validation** : Premier point de donnÃ©e rÃ©el en DB
- **Architecture** : Mise en place structure monorepo

### **Livrables Attendus**
- [ ] Migration `src/` â†’ `backend/` (restructuration)
- [ ] CrÃ©ation dossier `device/` + structure projet Python
- [ ] Script Python collecte tempÃ©rature/humiditÃ© 
- [ ] Configuration Raspberry Pi + rÃ©seau
- [ ] Premier flux de donnÃ©es rÃ©elles vers backend
- [ ] Documentation setup hardware
- [ ] Tests intÃ©gration bout-en-bout

---

## ğŸ“‹ **Plan d'ExÃ©cution**

### **Phase 1 : Restructuration Monorepo**
1. **Migration backend** : `src/` â†’ `backend/` âœ…
2. **Structure device** : CrÃ©ation `device/` + projet Python
3. **Update configs** : Docker, package.json, paths âœ…
4. **Validation** : Tests existants passent âœ…

**ğŸ¯ RÃ©sultats Phase 1 :**
- âœ… Backend migrÃ© vers `backend/` sans rÃ©gression
- âœ… Package.json + Dockerfile mis Ã  jour
- âœ… 164/164 tests passent
- âœ… Architecture monorepo prÃ©parÃ©e

### **Phase 2 : DÃ©veloppement Client Pi**
1. **Setup C** : Compilation toolchain + librairies I2C/MQTT
2. **Driver AHT20** : Interface I2C pour lecture capteur
3. **Client MQTT** : Publication donnÃ©es vers broker (libmosquitto)
4. **Configuration** : ParamÃ¨tres I2C + rÃ©seau + broker

### **Phase 3 : IntÃ©gration Hardware**
1. **Setup Raspberry Pi** : OS + I2C enabled + compilation
2. **Tests capteur** : Lecture tempÃ©rature/humiditÃ© AHT20
3. **Tests rÃ©seau** : ConnectivitÃ© MQTT + backend
4. **Validation** : DonnÃ©es visibles en DB

---

## ğŸ“Š **Architecture Technique**

### **Flux de DonnÃ©es**
```
[Raspberry Pi] â†’ [Capteur AHT20] â†’ [Script C] â†’ [MQTT: home/room/sensors/{device_uuid}/reading] â†’ [TechTemp Backend] â†’ [SQLite DB]
```

### **Architecture IDs**
- **device_uid** : Identifiant unique basÃ© MAC (ex: `aht20-b827eb123456`)
- **device_id** : Identifiant public MQTT (mÃªme valeur que device_uid)
- **MQTT Topics** : Utilisent device_id
- **API Publique** : Utilise device_uid ou device_id
- **Base DonnÃ©es** : Stocke device_id + device_uid

### **Technologies**
- **Hardware** : Raspberry Pi 4 + capteur AHT20 (I2C)
- **Client** : Langage C + librairies wiringPi/bcm2835 + libmosquitto
- **Backend** : Node.js service existant (inchangÃ©)
- **Communication** : MQTT (Mosquitto broker)
- **Protocol** : I2C pour capteur AHT20

---

## ğŸ› ï¸ **Changements PrÃ©vus**

### **Structure Projet**
```bash
# Migration backend
mv src/ backend/

# Nouveau client device
```bash
# Nouveau client device
device/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main.c            # Point d'entrÃ©e
â”‚   â”œâ”€â”€ aht20.c           # Driver capteur AHT20
â”‚   â”œâ”€â”€ aht20.h           # Header driver
â”‚   â”œâ”€â”€ mqtt_client.c     # Client MQTT
â”‚   â””â”€â”€ mqtt_client.h     # Header MQTT
â”œâ”€â”€ config/
â”‚   â””â”€â”€ device.conf       # Configuration
â”œâ”€â”€ Makefile              # Compilation
â””â”€â”€ README.md            # Setup + compilation
```
```

### **Configuration Docker**
- **Backend** : Update paths `src/` â†’ `backend/`
- **Device** : Nouveau service optionnel pour dev/test
- **Volumes** : Mapping configs + logs

---

## ğŸ”„ **Impact & Risques**

### **Impact Positif**
- âœ… **SimplicitÃ©** : Moins de repos Ã  gÃ©rer
- âœ… **CohÃ©rence** : Tout centralisÃ©
- âœ… **DÃ©veloppement** : Iterations plus rapides

### **Risques IdentifiÃ©s**
- âš ï¸ **Taille repo** : Peut grossir avec plusieurs composants
- âš ï¸ **DÃ©ploiement** : Plus complexe si composants indÃ©pendants
- âš ï¸ **CI/CD** : Pipelines Ã  adapter pour monorepo

### **Mitigation**
- ğŸ“ **Organisation claire** : Dossiers bien sÃ©parÃ©s
- ğŸš€ **Scripts deploy** : Par composant si nÃ©cessaire
- ğŸ”§ **CI sÃ©parÃ©** : Tests par dossier

---

## ğŸ¯ **CritÃ¨res de SuccÃ¨s**

### **Validation Technique**
- [x] Tests backend passent aprÃ¨s migration âœ… (164/164)
- [x] Corrections architecture device_id/device_uid âœ…
- [ ] Programme C compile et lit donnÃ©es capteur AHT20
- [ ] DonnÃ©es arrivent en base SQLite  
- [ ] API `/api/v1/readings` retourne donnÃ©es Pi

### **Validation Fonctionnelle**
- [ ] Raspberry Pi opÃ©rationnel + connectÃ©
- [ ] Capteur tempÃ©rature/humiditÃ© fonctionnel
- [ ] Flux temps rÃ©el visible en logs
- [ ] PremiÃ¨re lecture device_id rÃ©el en DB

---

## ğŸ“… **Timeline**

**11 septembre 2025 - Jour 1**
- [ ] Restructuration monorepo
- [ ] Setup projet device Python
- [ ] Premier script capteur

**Suite Ã  dÃ©finir selon avancement...**

---

## ğŸ“ **Notes de Session**

### **ğŸ”§ Phase 1 RÃ©alisÃ©e : Corrections Architecture (10 sept 2025)**

#### **ProblÃ¨mes IdentifiÃ©s & CorrigÃ©s :**

1. **IncohÃ©rence device_id vs device_uid**
   - **ProblÃ¨me** : Dans `backend/ingestion/ingestMessage.js`, lors de crÃ©ation auto d'un device :
   ```javascript
   device_id: parsedTopic.deviceId,        // ex: "aht20-b827eb123456"
   device_uid: `AUTO_${parsedTopic.deviceId}`, // ex: "AUTO_aht20-b827eb123456"
   ```
   - **Solution** : Synchronisation des valeurs (temporaire pour Journal #008)
   ```javascript
   device_id: parsedTopic.deviceId,        // ex: "aht20-b827eb123456"
   device_uid: parsedTopic.deviceId,       // ex: "aht20-b827eb123456"
   ```

2. **Recherche par mauvais champ**
   - **ProblÃ¨me** : `repository.devices.findById()` au lieu de `findByUid()`
   - **Solution** : Ajout `findByUid()` dans dataAccess + repositories + utilisation dans ingestion

#### **Changements Techniques :**
- âœ… `backend/db/dataAccess.js` : `createFindDeviceByUid()`
- âœ… `backend/repositories/index.js` : mÃ©thode `findByUid()`
- âœ… `backend/ingestion/ingestMessage.js` : utilise `findByUid()` 
- âœ… Tests mis Ã  jour : `test/ingestion/ingestMessage.test.js` + intÃ©gration
- âœ… **RÃ©sultat** : 164/164 tests passent

#### **Architecture Future (Post-Journal #008) :**
Refactorisation complÃ¨te prÃ©vue :
- `device_id` â†’ `INTEGER PRIMARY KEY AUTOINCREMENT` (clÃ© interne)
- `device_uid` â†’ `TEXT UNIQUE NOT NULL` (identifiant externe basÃ© MAC)
- Migration ~50+ occurrences code + APIs exposent seulement device_uid

---

## ğŸ”— **RÃ©fÃ©rences**
- **Journal #007** : Restructuration production (modifiÃ© par ce journal)
- **Documentation** : `docs/adr/` pour dÃ©cisions architecture
- **Backend API** : `backend/docs/api.md`
