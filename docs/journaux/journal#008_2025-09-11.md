# 📊 **Journal de Développement #0### **Scope Principal**
- **Hardware Setup** : Raspberry Pi + capteur AHT20
- **Client C** : Programme C avec driver AHT20 + publ### **Validation Technique**
- [ ] Tests backend passent après migration ✅
- [ ] Programme C compile et lit données capteur AHT20
- [ ] Données arrivent en base SQLite
- [ ] API `/api/v1/readings` retourne données Pi

### **Validation Fonctionnelle**
- [ ] Raspberry Pi opérationnel + I2C activé
- [ ] Capteur AHT20 fonctionnel via I2C
- [ ] Flux temps réel visible en logs
- [ ] Première lecture device_uid réel en DB (ex: aht20-b827eb123456)T
- **Configuration** : I2C + connexion broker MQTT
- **Validation** : Premier point de donnée réel en DB
- **Architecture** : Mise en place structure monorepo

### **Livrables Attendus**
- [ ] Migration `src/` → `backend/` (restructuration) ✅
- [ ] Création dossier `device/` + structure projet C
- [ ] Programme C collecte température/humidité via AHT20
- [ ] Driver I2C pour communication avec capteur AHT20
- [ ] Client MQTT en C pour publication données
- [ ] Configuration Raspberry Pi + I2C + réseau
- [ ] Premier flux de données réelles vers backend
- [ ] Documentation setup hardware + compilation
- [ ] Tests intégration bout-en-bout :** 11 septembre 2025  
**⏱️ Durée :** Session de développement  
**🎯 Objectif :** Premier Capteur Physique Raspberry Pi

---

## 🚨 **Changement Architecture Important**

### **⚠️ Modification Décision Journal #007**
**Ancienne décision :** Repositories séparés (`techtemp-device`, `techtemp-web`)  
**Nouvelle décision :** **Monorepo** - Tout dans `techtemp/`

### **Justification du Changement :**
- ✅ **Simplicité opérationnelle**
- ✅ **Documentation centralisée** : Journaux + code ensemble
- ✅ **Développement MVP** : Moins de complexité pour prototypage
- ✅ **Orchestration simplifiée** : Docker-compose unique

### **Nouvelle Structure Cible :**
```bash
techtemp/                    # Monorepo unifié
├── backend/                 # Service IoT (migration de src/)
├── device/                  # Client Raspberry Pi (Journal #008)
├── web/                     # Interface web (Journal #009)
├── docs/                    # Documentation + journaux
├── infrastructure/          # Docker, configs globales
└── scripts/                # Outils communs
```

---

## 🎯 **Objectifs Journal #008**

### **Scope Principal**
- **Hardware Setup** : Raspberry Pi + capteur AHT20/DHT22
- **Client Python** : Script collecte + publication MQTT
- **Configuration** : Network + connexion broker
- **Validation** : Premier point de donnée réel en DB
- **Architecture** : Mise en place structure monorepo

### **Livrables Attendus**
- [ ] Migration `src/` → `backend/` (restructuration)
- [ ] Création dossier `device/` + structure projet Python
- [ ] Script Python collecte température/humidité 
- [ ] Configuration Raspberry Pi + réseau
- [ ] Premier flux de données réelles vers backend
- [ ] Documentation setup hardware
- [ ] Tests intégration bout-en-bout

---

## 📋 **Plan d'Exécution**

### **Phase 1 : Restructuration Monorepo**
1. **Migration backend** : `src/` → `backend/` ✅
2. **Structure device** : Création `device/` + projet Python
3. **Update configs** : Docker, package.json, paths ✅
4. **Validation** : Tests existants passent ✅

**🎯 Résultats Phase 1 :**
- ✅ Backend migré vers `backend/` sans régression
- ✅ Package.json + Dockerfile mis à jour
- ✅ 164/164 tests passent
- ✅ Architecture monorepo préparée

### **Phase 2 : Développement Client Pi**
1. **Setup C** : Compilation toolchain + librairies I2C/MQTT
2. **Driver AHT20** : Interface I2C pour lecture capteur
3. **Client MQTT** : Publication données vers broker (libmosquitto)
4. **Configuration** : Paramètres I2C + réseau + broker

### **Phase 3 : Intégration Hardware**
1. **Setup Raspberry Pi** : OS + I2C enabled + compilation
2. **Tests capteur** : Lecture température/humidité AHT20
3. **Tests réseau** : Connectivité MQTT + backend
4. **Validation** : Données visibles en DB

---

## 📊 **Architecture Technique**

### **Flux de Données**
```
[Raspberry Pi] → [Capteur AHT20] → [Script C] → [MQTT: home/room/sensors/{device_uuid}/reading] → [TechTemp Backend] → [SQLite DB]
```

### **Architecture IDs**
- **device_uid** : Identifiant unique basé MAC (ex: `aht20-b827eb123456`)
- **device_id** : Identifiant public MQTT (même valeur que device_uid)
- **MQTT Topics** : Utilisent device_id
- **API Publique** : Utilise device_uid ou device_id
- **Base Données** : Stocke device_id + device_uid

### **Technologies**
- **Hardware** : Raspberry Pi 4 + capteur AHT20 (I2C)
- **Client** : Langage C + librairies wiringPi/bcm2835 + libmosquitto
- **Backend** : Node.js service existant (inchangé)
- **Communication** : MQTT (Mosquitto broker)
- **Protocol** : I2C pour capteur AHT20

---

## 🛠️ **Changements Prévus**

### **Structure Projet**
```bash
# Migration backend
mv src/ backend/

# Nouveau client device
```bash
# Nouveau client device
device/
├── src/
│   ├── main.c            # Point d'entrée
│   ├── aht20.c           # Driver capteur AHT20
│   ├── aht20.h           # Header driver
│   ├── mqtt_client.c     # Client MQTT
│   └── mqtt_client.h     # Header MQTT
├── config/
│   └── device.conf       # Configuration
├── Makefile              # Compilation
└── README.md            # Setup + compilation
```
```

### **Configuration Docker**
- **Backend** : Update paths `src/` → `backend/`
- **Device** : Nouveau service optionnel pour dev/test
- **Volumes** : Mapping configs + logs

---

## 🔄 **Impact & Risques**

### **Impact Positif**
- ✅ **Simplicité** : Moins de repos à gérer
- ✅ **Cohérence** : Tout centralisé
- ✅ **Développement** : Iterations plus rapides

### **Risques Identifiés**
- ⚠️ **Taille repo** : Peut grossir avec plusieurs composants
- ⚠️ **Déploiement** : Plus complexe si composants indépendants
- ⚠️ **CI/CD** : Pipelines à adapter pour monorepo

### **Mitigation**
- 📁 **Organisation claire** : Dossiers bien séparés
- 🚀 **Scripts deploy** : Par composant si nécessaire
- 🔧 **CI séparé** : Tests par dossier

---

## 🎯 **Critères de Succès**

### **Validation Technique**
- [x] Tests backend passent après migration ✅ (164/164)
- [x] Corrections architecture device_id/device_uid ✅
- [ ] Programme C compile et lit données capteur AHT20
- [ ] Données arrivent en base SQLite  
- [ ] API `/api/v1/readings` retourne données Pi

### **Validation Fonctionnelle**
- [ ] Raspberry Pi opérationnel + connecté
- [ ] Capteur température/humidité fonctionnel
- [ ] Flux temps réel visible en logs
- [ ] Première lecture device_id réel en DB

---

## 📅 **Timeline**

**11 septembre 2025 - Jour 1**
- [ ] Restructuration monorepo
- [ ] Setup projet device Python
- [ ] Premier script capteur

**Suite à définir selon avancement...**

---

## 📝 **Notes de Session**

### **🔧 Phase 1 Réalisée : Corrections Architecture (10 sept 2025)**

#### **Problèmes Identifiés & Corrigés :**

1. **Incohérence device_id vs device_uid**
   - **Problème** : Dans `backend/ingestion/ingestMessage.js`, lors de création auto d'un device :
   ```javascript
   device_id: parsedTopic.deviceId,        // ex: "aht20-b827eb123456"
   device_uid: `AUTO_${parsedTopic.deviceId}`, // ex: "AUTO_aht20-b827eb123456"
   ```
   - **Solution** : Synchronisation des valeurs (temporaire pour Journal #008)
   ```javascript
   device_id: parsedTopic.deviceId,        // ex: "aht20-b827eb123456"
   device_uid: parsedTopic.deviceId,       // ex: "aht20-b827eb123456"
   ```

2. **Recherche par mauvais champ**
   - **Problème** : `repository.devices.findById()` au lieu de `findByUid()`
   - **Solution** : Ajout `findByUid()` dans dataAccess + repositories + utilisation dans ingestion

#### **Changements Techniques :**
- ✅ `backend/db/dataAccess.js` : `createFindDeviceByUid()`
- ✅ `backend/repositories/index.js` : méthode `findByUid()`
- ✅ `backend/ingestion/ingestMessage.js` : utilise `findByUid()` 
- ✅ Tests mis à jour : `test/ingestion/ingestMessage.test.js` + intégration
- ✅ **Résultat** : 164/164 tests passent

#### **Architecture Future (Post-Journal #008) :**
Refactorisation complète prévue :
- `device_id` → `INTEGER PRIMARY KEY AUTOINCREMENT` (clé interne)
- `device_uid` → `TEXT UNIQUE NOT NULL` (identifiant externe basé MAC)
- Migration ~50+ occurrences code + APIs exposent seulement device_uid

---

## 🔗 **Références**
- **Journal #007** : Restructuration production (modifié par ce journal)
- **Documentation** : `docs/adr/` pour décisions architecture
- **Backend API** : `backend/docs/api.md`
