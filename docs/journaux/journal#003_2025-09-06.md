# Journal #003 ‚Äî Base SQLite + Config (2025-09-06)

## Objectif

Impl√©menter l'**infrastructure de donn√©es de base** pour le service-app :
- Configuration environment (via variables d'environnement)
- Initialisation SQLite avec sch√©ma contractuel
- Repository pattern pour acc√®s aux donn√©es
- Tests d'int√©gration SQLite

## Contexte

Journal #002 a livr√© le client MQTT robuste. Maintenant il faut la **fondation base de donn√©es** pour pouvoir stocker les lectures des capteurs selon le contrat 001.

## D√©cisions

- **SQLite** avec mode WAL activ√© pour les performances
- **better-sqlite3** comme driver (synchrone, performant)
- **Configuration via process.env** avec validation Joi
- **Migrations automatiques** au d√©marrage (fonction `migrateIfNeeded()`)
- **Repository pattern** pour encapsuler les requ√™tes SQL
- Tests avec **base temporaire** (`:memory:` ou fichier temp)

## Port√©e (Scope)

### ‚úÖ √Ä impl√©menter
- `src/config.js` : `loadConfig()` avec validation Joi des variables d'environnement
- `src/db/index.js` : 
  - `initDb(dbPath)` ‚Üí ouvre connexion + WAL + foreign_keys  
  - `createRepo(db)` ‚Üí repository avec m√©thodes CRUD
  - `closeDb()` ‚Üí fermeture propre
- **Sch√©ma SQLite** selon contrat 001 :
  - Tables : `rooms`, `devices`, `device_room_placements`, `readings_raw`
  - Vues : `v_room_last`
  - Index appropri√©s
- **Tests d'int√©gration** :
  - Configuration loading/validation
  - Database creation + schema migration
  - Repository CRUD operations
  - Fermeture propre (pas de handles ouverts)

### ‚ùå Hors Port√©e
- Pipeline d'ingestion MQTT ‚Üí DB (Journal #004)
- Serveur HTTP (Journal #005)
- API endpoints (Journal #006)
- Gestion des erreurs MQTT en production

## Plan d'impl√©mentation

### Phase 1: Configuration
- [ ] Impl√©menter `loadConfig()` avec sch√©ma Joi
- [ ] Variables requises : `NODE_ENV`, `DB_PATH`, `MQTT_URL`, `HTTP_PORT`
- [ ] Variables optionnelles : `MQTT_USERNAME`, `MQTT_PASSWORD`
- [ ] Tests : config valide/invalide, valeurs par d√©faut

### Phase 2: Base SQLite
- [ ] Impl√©menter `initDb(dbPath)` avec pragmas WAL + foreign_keys
- [ ] Fonction `migrateIfNeeded()` qui cr√©e le sch√©ma s'il n'existe pas
- [ ] Impl√©mentation du sch√©ma complet selon contrat 001
- [ ] Tests : cr√©ation DB, v√©rification sch√©ma, pragmas appliqu√©s

### Phase 3: Repository Pattern  
- [ ] `createRepo(db)` avec m√©thodes :
  - `upsertDevice(deviceRow)`
  - `insertReading(readingRow)` 
  - `getLatestReading(homeId, deviceId)`
- [ ] Tests : CRUD operations, contraintes de cl√©s √©trang√®res
- [ ] Test de fermeture propre (`closeDb()`)

### Phase 4: Tests d'int√©gration
- [ ] Tests avec base `:memory:` pour la rapidit√©
- [ ] Tests de concurrence (WAL mode)
- [ ] V√©rification pas de leaks de handles/connections

## Artifacts attendus

- `service-app/src/config.js` (impl√©mentation compl√®te)
- `service-app/src/db/index.js` (impl√©mentation compl√®te)  
- `service-app/test/config.test.js` (tests unitaires config)
- `service-app/test/db.test.js` (tests d'int√©gration DB)
- Mise √† jour `package.json` si nouvelles d√©pendances

## Crit√®res d'acceptation

‚úÖ **Config** : `loadConfig()` parse et valide les variables d'environnement  
‚úÖ **SQLite** : `initDb()` cr√©e la base avec sch√©ma complet et pragmas  
‚úÖ **Repository** : CRUD operations fonctionnent sur toutes les tables  
‚úÖ **Tests** : Tous les tests passent, pas de ressources qui fuient  
‚úÖ **Contrat** : Schema DB conforme exactement au contrat 001  

## Commandes pr√©vues

```bash
# Nouvelles d√©pendances
npm install better-sqlite3 joi

# Tests
npm run test -- db config

# V√©rification sch√©ma (manuel)
sqlite3 test.db ".schema"
```

## Liens utiles

- **Contrat 001** : `docs/contrats/001-base-service-app.md` (section 2 - SQLite)
- **Repository pattern** : encapsulation des requ√™tes SQL  
- **better-sqlite3 docs** : https://github.com/WiseLibs/better-sqlite3
- **Joi validation** : https://joi.dev/api/

---

üìù **Next** : Journal #004 ‚Äî Pipeline d'ingestion MQTT ‚Üí SQLite
