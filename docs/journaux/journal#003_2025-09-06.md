# Journal #003 â€” Base SQLite + Config (2025-09-06)

## Objectif

ImplÃ©menter l'**infrastructure de donnÃ©es de base** pour le service-app :
- Configuration environment (via variables d'environnement)
- Initialisation SQLite avec schÃ©ma contractuel
- Repository pattern pour accÃ¨s aux donnÃ©es
- Tests d'intÃ©gration SQLite

## Contexte

Journal #002 a livrÃ© le client MQTT robuste. Maintenant il faut la **fondation base de donnÃ©es** pour pouvoir stocker les lectures des capteurs selon le contrat 001.

## DÃ©cisions

- **SQLite** avec mode WAL activÃ© pour les performances
- **better-sqlite3** comme driver (synchrone, performant)
- **Configuration via process.env** avec validation Joi
- **Migrations automatiques** au dÃ©marrage (fonction `migrateIfNeeded()`)
- **Architecture en couches** : Repository (mÃ©tier) + Data Access (SQL) + Database (connexion)
- **Repository pattern correct** : logique mÃ©tier sans SQL direct
- Tests avec **base temporaire** (`:memory:` ou fichier temp)

## PortÃ©e (Scope)

### âœ… Ã€ implÃ©menter
- `src/config.js` : `loadConfig()` avec validation Joi des variables d'environnement
- `src/db/index.js` : 
  - `initDb(dbPath)` â†’ ouvre connexion + WAL + foreign_keys  
  - `closeDb()` â†’ fermeture propre
- `src/db/dataAccess.js` :
  - Couche d'accÃ¨s aux donnÃ©es avec SQL spÃ©cifique
  - `insertDevice()`, `insertReading()`, `findLatestReading()`, etc.
- `src/repositories/deviceRepository.js` :
  - Logique mÃ©tier pure (validation, transformation)
  - DÃ©lÃ©gation vers Data Access (pas de SQL direct)
- **SchÃ©ma SQLite** selon contrat 001 :
  - Tables : `rooms`, `devices`, `device_room_placements`, `readings_raw`
  - Vues : `v_room_last`
  - Index appropriÃ©s
- **Tests d'intÃ©gration** :
  - Configuration loading/validation
  - Database creation + schema migration
  - Repository avec mocks de Data Access
  - Data Access avec vraie base temporaire
  - Fermeture propre (pas de handles ouverts)

### âŒ Hors PortÃ©e
- Pipeline d'ingestion MQTT â†’ DB (Journal #004)
- Serveur HTTP (Journal #005)
- API endpoints (Journal #006)
- Gestion des erreurs MQTT en production

## Plan d'implÃ©mentation

### Phase 1: Configuration
- [x] Ã‰crire `test/config.test.js` avec cas de test :
  - Configuration valide avec toutes les variables
  - Variables manquantes â†’ erreur explicite
  - Variables invalides â†’ erreur avec dÃ©tails
  - Valeurs par dÃ©faut (ex: `TOPIC_READING_PATTERN`)
- [x] ImplÃ©menter `loadConfig()` pour faire passer les tests
- [x] Validation Joi avec schÃ©ma dÃ©taillÃ©

### Phase 2: Base SQLite
- [x] Ã‰crire `test/db.test.js` avec cas de test :
  - CrÃ©ation base + schÃ©ma complet
  - Pragmas WAL + foreign_keys appliquÃ©s
  - Migration idempotente (relancer n'ajoute rien)
  - Fermeture propre sans leaks
- [x] ImplÃ©menter `initDb(dbPath)` et `closeDb()`
- [x] ImplÃ©menter le schÃ©ma selon contrat 001

### Phase 3: Data Access 
- [x] Ã‰crire `test/dataAccess.test.js` avec cas de test :
  - CRUD operations sur chaque table
  - Contraintes de clÃ©s Ã©trangÃ¨res respectÃ©es
  - RequÃªtes complexes (jointures, agrÃ©gations)
  - Gestion d'erreurs SQL
- [x] ImplÃ©menter `createDataAccess(db)` avec mÃ©thodes SQL
- [x] VÃ©rifier performance avec base temporaire

### Phase 4: Repository 
- [x] Ã‰crire `test/repositories.test.js` avec cas de test :
  - Logique mÃ©tier pure (validation, transformation)
  - DÃ©lÃ©gation correcte vers Data Access  
  - Gestion d'erreurs mÃ©tier
  - Mocks de Data Access (pas de vraie DB)
- [x] ImplÃ©menter `createDeviceRepository(dataAccess)`
- [x] Tests d'intÃ©gration Repository + Data Access + DB

## Artifacts attendus

- `service-app/src/config.js` (implÃ©mentation complÃ¨te)
- `service-app/src/db/index.js` (connexion + migrations)
- `service-app/src/db/dataAccess.js` (couche SQL)
- `service-app/src/repositories/deviceRepository.js` (logique mÃ©tier)
- `service-app/test/config.test.js` (tests unitaires config)
- `service-app/test/db.test.js` (tests d'intÃ©gration DB)
- `service-app/test/repositories.test.js` (tests avec mocks)
- Mise Ã  jour `package.json` si nouvelles dÃ©pendances

## CritÃ¨res d'acceptation

âœ… **Config** : `loadConfig()` parse et valide les variables d'environnement  
âœ… **SQLite** : `initDb()` crÃ©e la base avec schÃ©ma complet et pragmas  
âœ… **Data Access** : Couche SQL avec mÃ©thodes CRUD sur toutes les tables  
âœ… **Repository** : Logique mÃ©tier pure sans SQL direct  
âœ… **Tests** : Tous les tests passent (71/71), pas de ressources qui fuient  
âœ… **Contrat** : Schema DB conforme exactement au contrat 001  
âœ… **Bonus** : Colonnes explicites (temperature/humidity) + DÃ©mos fonctionnelles  

## Commandes prÃ©vues

```bash
# Nouvelles dÃ©pendances
npm install better-sqlite3 joi

# Tests
npm run test -- db config

# VÃ©rification schÃ©ma (manuel)
sqlite3 test.db ".schema"
```

## Liens utiles

- **Contrat 001** : `docs/contrats/001-base-service-app.md` (section 2 - SQLite)
- **Repository pattern** : logique mÃ©tier sÃ©parÃ©e de l'accÃ¨s donnÃ©es
- **Data Access Layer** : couche SQL spÃ©cialisÃ©e par type de base
- **better-sqlite3 docs** : https://github.com/WiseLibs/better-sqlite3
- **Joi validation** : https://joi.dev/api/

---

ğŸ“ **Architecture en couches** :
```
Business Logic â†’ Repository (mÃ©tier) â†’ Data Access (SQL) â†’ Database (connexion)
```

ğŸ“ **Next** : Journal #004 â€” Pipeline d'ingestion MQTT â†’ SQLite

---

## ğŸ‰ BILAN FINAL â€” Journal #003 ACCOMPLI (7 septembre 2025)

### âœ… **STATUT : COMPLET**
**71 tests passent** â€¢ **Toutes les phases rÃ©alisÃ©es** â€¢ **Objectifs dÃ©passÃ©s**

### ğŸ“Š **RÃ‰ALISATIONS**

**Phase 1 - Configuration** âœ…
- `src/config.js` : Validation Joi complÃ¨te avec schÃ©ma dÃ©taillÃ©
- `test/config.test.js` : 15 tests couvrant tous les cas d'erreur
- Support des variables optionnelles (MQTT_USERNAME, MQTT_PASSWORD)
- Validation stricte des ports et URLs

**Phase 2 - Base SQLite** âœ…  
- `src/db/index.js` : Initialisation avec WAL + foreign_keys
- `test/db.test.js` : 8 tests d'intÃ©gration base + schÃ©ma
- SchÃ©ma complet selon contrat 001 avec **colonnes explicites**
- Migrations idempotentes et fermeture propre

**Phase 3 - Data Access** âœ…
- `src/db/dataAccess.js` : Couche SQL avec CRUD sur toutes les tables
- `test/dataAccess.test.js` : 8 tests avec contraintes et jointures
- RequÃªtes optimisÃ©es avec prÃ©paration et rÃ©utilisation
- Gestion d'erreurs SQL robuste

**Phase 4 - Repository** âœ…
- `src/repositories/index.js` : Logique mÃ©tier pure sans SQL
- `test/repositories.test.js` : 26 tests avec validation business
- Pattern Repository correct avec dÃ©lÃ©gation Data Access
- Validation des ranges (tempÃ©rature -50Â°C/100Â°C, humiditÃ© 0%/100%)

### ğŸš€ **BONUS ACCOMPLIS**
- **Colonnes explicites** : `temperature`/`humidity` au lieu de `t`/`h` 
- **DÃ©mos fonctionnelles** : Quick demo + Service complet avec MQTT rÃ©el
- **Base organisÃ©e** : `examples/db-example/` (pas de pollution racine)
- **Exploration intÃ©grÃ©e** : Inspection de base directement dans la dÃ©mo
- **Tests MQTT** : 14 tests avec broker Aedes intÃ©grÃ©

### ğŸ“ **ARTIFACTS LIVRÃ‰S**
```
service-app/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ config.js                    âœ… (62 lignes)
â”‚   â”œâ”€â”€ db/
â”‚   â”‚   â”œâ”€â”€ index.js                 âœ… (134 lignes) 
â”‚   â”‚   â””â”€â”€ dataAccess.js            âœ… (140 lignes)
â”‚   â””â”€â”€ repositories/
â”‚       â””â”€â”€ index.js                 âœ… (167 lignes)
â”œâ”€â”€ test/
â”‚   â”œâ”€â”€ config.test.js               âœ… (15 tests)
â”‚   â”œâ”€â”€ db.test.js                   âœ… (8 tests)  
â”‚   â”œâ”€â”€ dataAccess.test.js           âœ… (8 tests)
â”‚   â”œâ”€â”€ repositories.test.js         âœ… (26 tests)
â”‚   â””â”€â”€ mqtt.client.test.js          âœ… (14 tests)
â””â”€â”€ examples/
    â”œâ”€â”€ quick-demo.js                âœ… Demo simple
    â”œâ”€â”€ service-complete-demo.js     âœ… Demo MQTT rÃ©el
    â””â”€â”€ db-example/                  âœ… Organisation propre
```

### ğŸ’¾ **Ã‰TAT TECHNIQUE**
- **71/71 tests** passent (100% succÃ¨s)
- **4 dÃ©pendances** : better-sqlite3, joi, mqtt, aedes/vitest
- **Schema DB** : 4 tables + vues + index conformes contrat 001
- **Performance** : WAL mode, requÃªtes prÃ©parÃ©es, pas de leaks mÃ©moire
- **Architecture** : SÃ©paration claire Repository â†’ Data Access â†’ Database

### ğŸ”„ **TRANSITION JOURNAL #004**
Les fondations sont **solides et complÃ¨tes**. Le prochain journal peut se concentrer sur :
- Pipeline d'ingestion MQTT â†’ SQLite (modules prÃªts)
- Serveur HTTP (base et repository disponibles)
- IntÃ©gration complÃ¨te des composants
