# Journal #009 - 12 septembre 2025

## 🎯 Objectif du journal
Finalisation du déploiement Pi serveur/client et consolidation MVP

## 📋 Points traités

### ✅ 1. Migration serveur vers Pi (.42)
- **Problème** : Serveur TechTemp initialement en Docker local
- **Solution** : Déploiement complet sur Raspberry Pi 192.168.0.42
- **Résultat** : 
  - ✅ Backend API fonctionnel sur http://192.168.0.42:3000
  - ✅ MQTT Broker opérationnel sur port 1883
  - ✅ Base SQLite persistante via volumes Docker
  - ✅ Conteneurs Docker (techtemp-service + mosquitto) stables

### ✅ 2. Configuration Pi capteur (.134) 
- **Migration** : Pi capteur pointant vers nouveau serveur
- **Configuration** : 
  - Device UID: `aht20-f49c53`
  - Room: `eetkamer` 
  - Fréquence: 300s (5 minutes)
- **Résultat** : Flux de données capteur → serveur Pi opérationnel

### ✅ 3. Script de déploiement robuste
- **Problème** : Script initial peu fiable (permissions Docker, espace disque, conflits ports)
- **Créé** : `scripts/deploy-robust-pi.sh`
- **Fonctionnalités** :
  - Vérifications préliminaires (connectivité, SSH, espace disque)
  - Installation/configuration Docker automatique
  - Gestion conflits de ports (1883, 3000)
  - Logging complet et gestion d'erreurs
  - Test API automatique
- **Validé** : Déploiement réussi en conditions réelles

### ✅ 4. Outils d'inspection base de données
- **Créé** : `scripts/remote-db-inspect.sh`
- **Fonctionnalités** : Inspection distante des tables via Docker
- **Résultat** : Monitoring complet de l'état de la base
  - 1 device actif (`aht20-f49c53`)
  - 1 room (`eetkamer`)
  - 1 placement actif  
  - 52+ lectures collectées

### ✅ 5. Architecture device_room_placements
- **Validation** : Table de tracking fonctionnelle
- **Schema** : device_id + room_id + from_ts + to_ts (historisation)
- **Status** : 1 placement actif depuis 2025-09-11T22:13:28.721Z

### ✅ 6. Test robustesse mises à jour
- **Test** : Simulation rebuild complet containers
- **Résultat** : ✅ Données 100% préservées via volumes Docker
- **Validation** : 52 lectures conservées après mise à jour

### ✅ 7. Configuration runtime
- **Modification** : Fréquence capteur 30s → 300s à chaud
- **Méthode** : Edit config + restart service systemd
- **Résultat** : Prise en compte immédiate sans redéploiement

## 🏗️ Infrastructure finale

### Pi Serveur (192.168.0.42)
```
🐳 Docker Compose
├── techtemp-service (API REST + ingestion MQTT)
├── techtemp-mosquitto (MQTT Broker)
└── volumes persistants (base SQLite)

📊 APIs disponibles:
- GET /health → {"status":"ok"}
- GET /api/v1/devices → Liste devices
- GET /api/v1/readings/latest?deviceId=X → Lectures récentes
```

### Pi Capteur (192.168.0.134)  
```
🔧 Systemd Service
├── techtemp-device (lecture AHT20 + publish MQTT)
├── Fréquence: 300s (5 minutes)
└── Target: 192.168.0.42:1883

📡 Flux: AHT20 → Pi → MQTT → Serveur → SQLite
```

## 📊 Métriques

### Base de données
- **Devices** : 1 (aht20-f49c53)
- **Rooms** : 1 (eetkamer)  
- **Placements** : 1 actif
- **Lectures** : 52+ (croissance continue)

### Performance
- **Fréquence capteur** : 300s (économie énergie)
- **Latence ingestion** : < 1s (MQTT → SQLite)
- **APIs** : Réponse instantanée
- **Uptime** : 26h+ en continu

## 🛠️ Outils créés

### Scripts de déploiement
- `scripts/deploy-robust-pi.sh` : Déploiement serveur complet
- `scripts/remote-db-inspect.sh` : Inspection base distante
- `deployment/bootstrap-pi.sh` : Configuration device (existant amélioré)

### Documentation
- Tous les scripts avec logging et gestion d'erreurs
- Tests de robustesse validés

## 🔧 Commandes utiles pour l'opérationnel

### Serveur Pi
```bash
# Status conteneurs
ssh pi@192.168.0.42 'cd /home/pi/techtemp && docker compose ps'

# Logs temps réel
ssh pi@192.168.0.42 'cd /home/pi/techtemp && docker compose logs -f'

# Redéploiement
./scripts/deploy-robust-pi.sh 192.168.0.42

# Inspection base
./scripts/remote-db-inspect.sh 192.168.0.42
```

### Capteur Pi
```bash
# Status service
ssh pi@192.168.0.134 'sudo systemctl status techtemp-device'

# Modification fréquence
ssh pi@192.168.0.134 'sudo sed -i "s/read_interval_seconds = 300/read_interval_seconds = 60/" /home/pi/techtemp/device/config/device.conf'
ssh pi@192.168.0.134 'sudo systemctl restart techtemp-device'
```

## 📈 Évolutions identifiées

### Priorité 1 (MVP Lot 1 - Point 4)
- **Interface Web** : Dashboard visualisation données
- **Graphiques** : Historique température/humidité 
- **API enrichie** : Endpoints statistiques

### Priorité 2  
- **Multi-devices** : Support plusieurs capteurs
- **Alertes** : Seuils température/humidité
- **Historisation** : Rétention longue terme

### Priorité 3
- **Monitoring** : Grafana + Prometheus
- **Sauvegarde** : Backup automatique base
- **Sécurité** : HTTPS + authentification

## 🎉 Validation MVP Lot 1 (Points 1-3)

### ✅ Point 1 : Backend IoT opérationnel
- Architecture microservices (Docker)
- Ingestion MQTT temps réel  
- Base SQLite avec schema robuste
- APIs REST fonctionnelles

### ✅ Point 2 : Device physique connecté
- Capteur AHT20 fonctionnel
- Communication MQTT stable
- Placement tracking actif
- Configuration runtime

### ✅ Point 3 : Déploiement production Pi
- Infrastructure distribuée (serveur + device)
- Scripts déploiement robustes
- Volumes persistants
- Monitoring intégré

## 🚀 Prêt pour Point 4 : Interface Web

L'infrastructure backend/device est **solidement établie** et **opérationnelle en production**.

Prochaine étape : Développement interface web pour visualisation et contrôle du système TechTemp.

---

**Status** : 🎯 **MVP Lot 1 Points 1-3 VALIDÉS** 
**Next** : 🚀 **Point 4 - Interface Web Dashboard**
