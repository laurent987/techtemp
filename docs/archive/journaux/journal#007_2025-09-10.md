# Journal #007 — Production Deployment & Infrastructure (2025-09-10)

## Objectif

Restructurer et déployer l'application TechTemp IoT en **configuration production** avec Docker :
- Restructuration du projet en service backend focalisé
- Dockerfile multi-stage optimisé pour la production
- Stack Docker complet avec MQTT broker
- Configuration production et monitoring
- Documentation et exemples clients

## Contexte

Journal #006 a livré **Application Orchestration complète** :
- ✅ Bootstrap d'application complet avec `src/main.js`
- ✅ Gestion du cycle de vie (start/stop/graceful shutdown)
- ✅ Gestion des signaux et configuration par environnement
- ✅ Orchestration complète MQTT → DB → HTTP (164 tests OK)
- ✅ Application production-ready avec logging structuré

Maintenant nous devons **déployer et structurer** le projet pour la production avec Docker.

## Décisions

### Architecture & Structure
- **Scope du repository** : Service IoT backend uniquement (focus)
- **Clients production** : Repositories séparés (`techtemp-web`, `techtemp-device`)
- **Exemples clients** : Dans `clients/` pour démonstration
- **Package.json unifié** : Une seule source de dépendances
- **Structure simplifiée** : `src/` + `test/` + `infrastructure/` + `clients/`

### Déploiement Docker
- **Dockerfile multi-stage** : Optimisation pour production (Node 20)
- **Images légères** : Build dependencies séparées du runtime
- **Stack complet** : TechTemp + Mosquitto MQTT + monitoring optionnel
- **Configuration réseau** : Bridge network pour communication inter-services
- **Volumes persistants** : Données SQLite et logs Mosquitto

### Production & Sécurité
- **Utilisateur non-root** : Container sécurisé
- **Health checks** : Monitoring automatique des services
- **Signal handling** : dumb-init pour gestion propre des signaux
- **Variables d'environnement** : Configuration externalisée

## Artefacts produits

### Structure restructurée
```
techtemp/
├── src/                    # Service IoT backend (ex: service-app/src)
├── test/                   # Tests (ex: service-app/test)
├── clients/               # Exemples clients (web, raspberry pi)
│   ├── web-example/       # Dashboard web simple
│   └── device-example/    # Client Raspberry Pi
├── infrastructure/        # Configs Docker & monitoring
│   └── mosquitto/config/  # Configuration MQTT
├── package.json          # Dépendances unifiées
├── Dockerfile            # Multi-stage optimisé
├── docker-compose.yml    # Stack complet
└── .dockerignore         # Optimisation builds
```

### Fichiers Docker
- **`Dockerfile`** : Multi-stage avec Node 20, build deps séparées, utilisateur non-root
- **`docker-compose.yml`** : TechTemp service + Mosquitto MQTT + monitoring optionnel
- **`infrastructure/mosquitto/config/mosquitto.conf`** : Configuration MQTT permissive
- **`.dockerignore`** : Exclusion fichiers dev/test

### Documentation mise à jour
- **`README.md`** : Scope clarifié (backend service uniquement)
- **`clients/README.md`** : Guide des exemples clients
- **`package.json`** : Scripts Docker intégrés, description mise à jour

## Commandes exécutées

### Restructuration
```bash
# Déplacement du code principal
mv service-app/src/* src/
mv service-app/test test/

# Nettoyage des dossiers obsolètes
rm -rf devices/ logs/ 
rm -rf apps/web-dashboard/node_modules/
mv apps web
mv examples docs/

# Fusion package.json
# Ajout winston + scripts Docker
```

### Tests et validation
```bash
# Tests après restructuration
npm test                    # ✅ 164/164 tests passent

# Test service standalone
NODE_ENV=development DB_PATH=./test.db MQTT_URL=mqtt://localhost:1883 HTTP_PORT=3000 npm start

# Nettoyage containers existants
docker stop techtemp-app techtemp-grafana techtemp-mosquitto techtemp-prometheus
docker rm techtemp-app techtemp-grafana techtemp-mosquitto techtemp-prometheus
```

### Déploiement Docker
```bash
# Build et démarrage du stack
docker-compose up --build

# Test en mode détaché
docker-compose up -d

# Validation API
curl http://localhost:3000/health  # ✅ {"status":"ok"}
```

## Critères d'acceptation

### ✅ Structure & Organisation
- [x] Code restructuré : `src/` + `test/` à la racine
- [x] Dossiers obsolètes supprimés (devices, logs, etc.)
- [x] Package.json unifié avec dépendances consolidées
- [x] Scope du projet clarifié (backend service uniquement)
- [x] Exemples clients organisés dans `clients/`

### ✅ Docker & Déploiement
- [x] Dockerfile multi-stage fonctionnel avec Node 20
- [x] Stack Docker complet (TechTemp + Mosquitto) opérationnel
- [x] Configuration MQTT permissive pour communications inter-containers
- [x] Variables d'environnement correctement configurées
- [x] Volumes persistants pour données et logs

### ✅ Validation Fonctionnelle
- [x] Tous les tests passent après restructuration (164/164)
- [x] Service démarre correctement en mode standalone
- [x] Stack Docker démarre sans erreurs
- [x] API `/health` répond avec `{"status":"ok"}`
- [x] Connexion MQTT établie entre services
- [x] Logs structurés et propres

### ✅ Production Ready
- [x] Container sécurisé (utilisateur non-root)
- [x] Health checks configurés
- [x] Gestion propre des signaux (dumb-init)
- [x] Configuration externalisée par variables d'environnement
- [x] Documentation mise à jour

## Problèmes résolus

### 1. Conflits de versions Node.js
**Problème** : Dépendances `better-sqlite3` et `joi` nécessitent Node 20+, Dockerfile utilisait Node 18
**Solution** : Migration vers Node 20-alpine + ajout build dependencies (python3, make, g++)

### 2. Configuration MQTT restrictive
**Problème** : Mosquitto en "local only mode" refusait les connexions inter-containers
**Solution** : Configuration permissive avec `listener 1883 0.0.0.0` et `allow_anonymous true`

### 3. Variables d'environnement manquantes
**Problème** : Variable `HTTP_PORT` requise mais non définie dans docker-compose
**Solution** : Ajout de toutes les variables requises dans la section `environment`

### 4. Structure projet incohérente
**Problème** : Mélange service backend + exemples web + code device dans la même structure
**Solution** : Focus sur service backend uniquement, exemples clients séparés

## Suivi / TODO

### Améliorations possibles
- [ ] Ajouter Prometheus monitoring avec profils (`docker-compose --profile monitoring up`)
- [ ] Créer exemples clients fonctionnels (web dashboard, simulateur device)
- [ ] Implémenter configuration avancée Mosquitto (authentification, TLS)
- [ ] Ajouter scripts de déploiement automatisé
- [ ] Optimiser images Docker (taille finale, layers)

### Prochaines étapes
- [ ] **Journal #008** : Monitoring & Observabilité (Prometheus + Grafana)
- [ ] **Journal #009** : Client Web Dashboard
- [ ] **Journal #010** : Client Device (Raspberry Pi)

---

## Résultat final

✅ **Service TechTemp IoT production-ready** avec :
- Structure projet cohérente et focalisée
- Déploiement Docker complet et fonctionnel
- Configuration production sécurisée
- Stack MQTT + Backend + API opérationnelle
- Base solide pour développement clients

**Commandes de démarrage** :
```bash
docker-compose up -d        # Démarrer le stack
curl localhost:3000/health  # Vérifier le service
docker-compose logs -f      # Voir les logs
```
