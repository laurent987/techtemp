# Journal #009 - 12 septembre 2025

## ğŸ¯ Objectif du journal
Finalisation du dÃ©ploiement Pi serveur/client et consolidation MVP

## ğŸ“‹ Points traitÃ©s

### âœ… 1. Migration serveur vers Pi (.42)
- **ProblÃ¨me** : Serveur TechTemp initialement en Docker local
- **Solution** : DÃ©ploiement complet sur Raspberry Pi 192.168.0.42
- **RÃ©sultat** : 
  - âœ… Backend API fonctionnel sur http://192.168.0.42:3000
  - âœ… MQTT Broker opÃ©rationnel sur port 1883
  - âœ… Base SQLite persistante via volumes Docker
  - âœ… Conteneurs Docker (techtemp-service + mosquitto) stables

### âœ… 2. Configuration Pi capteur (.134) 
- **Migration** : Pi capteur pointant vers nouveau serveur
- **Configuration** : 
  - Device UID: `aht20-f49c53`
  - Room: `eetkamer` 
  - FrÃ©quence: 300s (5 minutes)
- **RÃ©sultat** : Flux de donnÃ©es capteur â†’ serveur Pi opÃ©rationnel

### âœ… 3. Script de dÃ©ploiement robuste
- **ProblÃ¨me** : Script initial peu fiable (permissions Docker, espace disque, conflits ports)
- **CrÃ©Ã©** : `scripts/deploy-robust-pi.sh`
- **FonctionnalitÃ©s** :
  - VÃ©rifications prÃ©liminaires (connectivitÃ©, SSH, espace disque)
  - Installation/configuration Docker automatique
  - Gestion conflits de ports (1883, 3000)
  - Logging complet et gestion d'erreurs
  - Test API automatique
- **ValidÃ©** : DÃ©ploiement rÃ©ussi en conditions rÃ©elles

### âœ… 4. Outils d'inspection base de donnÃ©es
- **CrÃ©Ã©** : `scripts/remote-db-inspect.sh`
- **FonctionnalitÃ©s** : Inspection distante des tables via Docker
- **RÃ©sultat** : Monitoring complet de l'Ã©tat de la base
  - 1 device actif (`aht20-f49c53`)
  - 1 room (`eetkamer`)
  - 1 placement actif  
  - 52+ lectures collectÃ©es

### âœ… 5. Architecture device_room_placements
- **Validation** : Table de tracking fonctionnelle
- **Schema** : device_id + room_id + from_ts + to_ts (historisation)
- **Status** : 1 placement actif depuis 2025-09-11T22:13:28.721Z

### âœ… 6. Test robustesse mises Ã  jour
- **Test** : Simulation rebuild complet containers
- **RÃ©sultat** : âœ… DonnÃ©es 100% prÃ©servÃ©es via volumes Docker
- **Validation** : 52 lectures conservÃ©es aprÃ¨s mise Ã  jour

### âœ… 7. Configuration runtime
- **Modification** : FrÃ©quence capteur 30s â†’ 300s Ã  chaud
- **MÃ©thode** : Edit config + restart service systemd
- **RÃ©sultat** : Prise en compte immÃ©diate sans redÃ©ploiement

## ğŸ—ï¸ Infrastructure finale

### Pi Serveur (192.168.0.42)
```
ğŸ³ Docker Compose
â”œâ”€â”€ techtemp-service (API REST + ingestion MQTT)
â”œâ”€â”€ techtemp-mosquitto (MQTT Broker)
â””â”€â”€ volumes persistants (base SQLite)

ğŸ“Š APIs disponibles:
- GET /health â†’ {"status":"ok"}
- GET /api/v1/devices â†’ Liste devices
- GET /api/v1/readings/latest?deviceId=X â†’ Lectures rÃ©centes
```

### Pi Capteur (192.168.0.134)  
```
ğŸ”§ Systemd Service
â”œâ”€â”€ techtemp-device (lecture AHT20 + publish MQTT)
â”œâ”€â”€ FrÃ©quence: 300s (5 minutes)
â””â”€â”€ Target: 192.168.0.42:1883

ğŸ“¡ Flux: AHT20 â†’ Pi â†’ MQTT â†’ Serveur â†’ SQLite
```

## ğŸ“Š MÃ©triques

### Base de donnÃ©es
- **Devices** : 1 (aht20-f49c53)
- **Rooms** : 1 (eetkamer)  
- **Placements** : 1 actif
- **Lectures** : 52+ (croissance continue)

### Performance
- **FrÃ©quence capteur** : 300s (Ã©conomie Ã©nergie)
- **Latence ingestion** : < 1s (MQTT â†’ SQLite)
- **APIs** : RÃ©ponse instantanÃ©e
- **Uptime** : 26h+ en continu

## ğŸ› ï¸ Outils crÃ©Ã©s

### Scripts de dÃ©ploiement
- `scripts/deploy-robust-pi.sh` : DÃ©ploiement serveur complet
- `scripts/remote-db-inspect.sh` : Inspection base distante
- `deployment/bootstrap-pi.sh` : Configuration device (existant amÃ©liorÃ©)

### Documentation
- Tous les scripts avec logging et gestion d'erreurs
- Tests de robustesse validÃ©s

## ğŸ”§ Commandes utiles pour l'opÃ©rationnel

### Serveur Pi
```bash
# Status conteneurs
ssh pi@192.168.0.42 'cd /home/pi/techtemp && docker compose ps'

# Logs temps rÃ©el
ssh pi@192.168.0.42 'cd /home/pi/techtemp && docker compose logs -f'

# RedÃ©ploiement
./scripts/deploy-robust-pi.sh 192.168.0.42

# Inspection base
./scripts/remote-db-inspect.sh 192.168.0.42
```

### Capteur Pi
```bash
# Status service
ssh pi@192.168.0.134 'sudo systemctl status techtemp-device'

# Modification frÃ©quence
ssh pi@192.168.0.134 'sudo sed -i "s/read_interval_seconds = 300/read_interval_seconds = 60/" /home/pi/techtemp/device/config/device.conf'
ssh pi@192.168.0.134 'sudo systemctl restart techtemp-device'
```

## ğŸ“ˆ Ã‰volutions identifiÃ©es

### PrioritÃ© 1 (MVP Lot 1 - Point 4)
- **Interface Web** : Dashboard visualisation donnÃ©es
- **Graphiques** : Historique tempÃ©rature/humiditÃ© 
- **API enrichie** : Endpoints statistiques

### PrioritÃ© 2  
- **Multi-devices** : Support plusieurs capteurs
- **Alertes** : Seuils tempÃ©rature/humiditÃ©
- **Historisation** : RÃ©tention longue terme

### PrioritÃ© 3
- **Monitoring** : Grafana + Prometheus
- **Sauvegarde** : Backup automatique base
- **SÃ©curitÃ©** : HTTPS + authentification

## ğŸ‰ Validation MVP Lot 1 (Points 1-3)

### âœ… Point 1 : Backend IoT opÃ©rationnel
- Architecture microservices (Docker)
- Ingestion MQTT temps rÃ©el  
- Base SQLite avec schema robuste
- APIs REST fonctionnelles

### âœ… Point 2 : Device physique connectÃ©
- Capteur AHT20 fonctionnel
- Communication MQTT stable
- Placement tracking actif
- Configuration runtime

### âœ… Point 3 : DÃ©ploiement production Pi
- Infrastructure distribuÃ©e (serveur + device)
- Scripts dÃ©ploiement robustes
- Volumes persistants
- Monitoring intÃ©grÃ©

## ğŸš€ PrÃªt pour Point 4 : Interface Web

L'infrastructure backend/device est **solidement Ã©tablie** et **opÃ©rationnelle en production**.

Prochaine Ã©tape : DÃ©veloppement interface web pour visualisation et contrÃ´le du systÃ¨me TechTemp.

---

**Status** : ğŸ¯ **MVP Lot 1 Points 1-3 VALIDÃ‰S** 
**Next** : ğŸš€ **Point 4 - Interface Web Dashboard**
