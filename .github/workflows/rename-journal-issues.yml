name: Rename + Autonumber Journal Issues

on:
  issues:
    types: [opened, labeled]

permissions:
  issues: write

jobs:
  rename:
    if: contains(join(github.event.issue.labels.*.name, ','), 'journal')
    runs-on: ubuntu-latest
    steps:
      - name: Rename title and (on open) comment metadata
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issue = context.payload.issue;
            const action = context.payload.action;
            const body = issue.body || '';
            const currentTitle = issue.title || '';

            const pick = (regexes) => {
              for (const r of regexes) {
                const m = body.match(r);
                if (m && m[1]) return m[1].trim();
              }
              return '';
            };

            const sujetFromForm = pick([/###\s*Subject \(short\)\s*\n+([^\n#]+)/i]);
            const objectifFirstLine = pick([/###\s*Objective\s*\n+([^\n#]+)/i, /###\s*Objectif\s*\n+([^\n#]+)/i]);

            const dateFromForm = pick([/###\s*Date\s*\n+([^\n#]+)/i]);
            const todayBrussels = new Intl.DateTimeFormat('fr-CA', { timeZone: 'Europe/Brussels' }).format(new Date());
            const datePart = (/^\d{4}-\d{2}-\d{2}$/.test(dateFromForm) ? dateFromForm : todayBrussels);

            let idVal = pick([/###\s*NumÃ©ro d'entrÃ©e\s*\n+([^\n#]+)/i, /###\s*Entry number\s*\n+([^\n#]+)/i]);
            if (!idVal) {
              let page = 1, maxId = 0;
              while (true) {
                const { data } = await github.rest.issues.listForRepo({
                  owner, repo, labels: 'journal', state: 'all', per_page: 100, page
                });
                if (!data.length) break;
                for (const it of data) {
                  const m = it.title.match(/Journal\s*#\s*(\d{1,6})\b/i);
                  if (m) {
                    const n = parseInt(m[1], 10);
                    if (!Number.isNaN(n) && n > maxId) maxId = n;
                  }
                }
                if (data.length < 100) break;
                page++;
              }
              idVal = String(maxId + 1).padStart(3, '0');
            }

            const shorten = (s, n = 50) => {
              const t = (s || '').replace(/\r/g, '').trim();
              return t.length > n ? t.slice(0, n - 1) + 'â€¦' : t || 'Work entry';
            };
            const subject = shorten(sujetFromForm || objectifFirstLine || currentTitle.replace(/^Journal.*?â€”\s*/i, ''), 50);

            const newTitle = `Journal #${idVal} â€” ${datePart} â€” ${subject}`;

            if (newTitle !== currentTitle) {
              await github.rest.issues.update({
                owner, repo, issue_number: issue.number, title: newTitle
              });
            }

            if (action === 'opened') {
              await github.rest.issues.createComment({
                owner, repo, issue_number: issue.number,
                body: `ğŸ—’ï¸ **Journal #${idVal} â€” ${datePart}**\n\n_Titre auto-gÃ©nÃ©rÃ© Ã  partir de lâ€™objectif. Si besoin, Ã©dite lâ€™objectif : le bot gardera le titre synchronisÃ©._`
              });
            }
